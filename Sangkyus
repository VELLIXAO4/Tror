-- ==========================================
-- Precision Damage Multiplier Script
-- Berdasarkan analisis IL2CPP MobPrefabSetting & ProtegePrefabSetting
-- Namespace-aware dan field-specific
-- ==========================================

gg.setRanges(gg.REGION_C_ALLOC | gg.REGION_CODE_APP)
gg.clearResults()

-- Konfigurasi berdasarkan namespace yang benar
local LIB_NAME = "libil2cpp.so"
local MOB_NAMESPACE = "MobPrefabSetting"
local PROTEGE_NAMESPACE = "ProtegePrefabSetting"

-- Field addresses berdasarkan namespace yang tepat
local MOB_FIELDS = {
    {
        name = "DisableDamageMotionAtSkillBreak",
        offset = 0xB4, 
        type = gg.TYPE_BOOL,
        namespace = MOB_NAMESPACE,
        description = "Nonaktifkan motion damage saat skill break"
    },
    {
        name = "DamageEffectSetColor", 
        offset = 0xB5,
        type = gg.TYPE_BOOL,
        namespace = MOB_NAMESPACE,
        description = "Aktifkan warna custom untuk efek damage"
    },
    {
        name = "DamageEffectColor_R",
        offset = 0xB8,
        type = gg.TYPE_FLOAT,
        namespace = MOB_NAMESPACE,
        description = "Warna Red efek damage"
    },
    {
        name = "DamageEffectColor_G",
        offset = 0xBC, 
        type = gg.TYPE_FLOAT,
        namespace = MOB_NAMESPACE,
        description = "Warna Green efek damage"
    },
    {
        name = "DamageEffectColor_B",
        offset = 0xC0,
        type = gg.TYPE_FLOAT,
        namespace = MOB_NAMESPACE,
        description = "Warna Blue efek damage"
    },
    {
        name = "DeadSinkSpeed",
        offset = 0xE0,
        type = gg.TYPE_FLOAT,
        namespace = MOB_NAMESPACE,
        description = "Kecepatan sink karakter mati"
    }
}

local PROTEGE_FIELDS = {
    {
        name = "DamageEffectSetColor",
        offset = 0x84,
        type = gg.TYPE_BOOL,
        namespace = PROTEGE_NAMESPACE,
        description = "Aktifkan warna custom efek damage (Protege)"
    },
    {
        name = "DamageEffectColor_R",
        offset = 0x88,
        type = gg.TYPE_FLOAT,
        namespace = PROTEGE_NAMESPACE,
        description = "Warna Red efek damage (Protege)"
    },
    {
        name = "DamageEffectColor_G",
        offset = 0x8C,
        type = gg.TYPE_FLOAT,
        namespace = PROTEGE_NAMESPACE,
        description = "Warna Green efek damage (Protege)"
    },
    {
        name = "DamageEffectColor_B",
        offset = 0x90,
        type = gg.TYPE_FLOAT,
        namespace = PROTEGE_NAMESPACE,
        description = "Warna Blue efek damage (Protege)"
    }
}

-- Method offsets untuk hooking
local METHOD_OFFSETS = {
    {
        name = "GetDisableDamageMotionAtSkillBreak",
        offset = 0x2F22A58,
        type = gg.TYPE_DWORD,
        namespace = MOB_NAMESPACE,
        description = "Method untuk disable damage motion"
    },
    {
        name = "GetDamageEffectPath", 
        offset = 0x2E2E354,
        type = gg.TYPE_DWORD,
        namespace = MOB_NAMESPACE,
        description = "Method untuk path efek damage"
    }
}

-- Gabungkan semua field
local ALL_FIELDS = {}
for _, field in ipairs(MOB_FIELDS) do table.insert(ALL_FIELDS, field) end
for _, field in ipairs(PROTEGE_FIELDS) do table.insert(ALL_FIELDS, field) end
for _, method in ipairs(METHOD_OFFSETS) do table.insert(ALL_FIELDS, method) end

-- Variabel global
local original_values = {}
local base_address = 0
local current_multiplier = 1.0
local is_active = false

-- Fungsi mendapatkan base address
function get_base_address()
    local ranges = gg.getRangesList(LIB_NAME)
    if #ranges == 0 then
        gg.alert("‚ùå " .. LIB_NAME .. " tidak ditemukan!")
        os.exit()
    end
    return ranges[1].start
end

-- Backup nilai original berdasarkan namespace
function backup_namespace_values()
    base_address = get_base_address()
    original_values = {}
    
    for _, field in ipairs(ALL_FIELDS) do
        local success, result = pcall(function()
            return gg.getValues({{address = base_address + field.offset, flags = field.type}})[1].value
        end)
        
        if success then
            original_values[field.name] = {
                address = base_address + field.offset,
                value = result,
                flags = field.type,
                namespace = field.namespace,
                description = field.description
            }
        end
    end
    
    gg.toast("‚úÖ Backup berhasil: " .. #ALL_FIELDS .. " field")
end

-- Menu untuk memilih field berdasarkan namespace
function select_field_menu()
    local menu_options = {}
    local field_map = {}
    
    -- Group oleh namespace
    local namespace_groups = {
        [MOB_NAMESPACE] = {},
        [PROTEGE_NAMESPACE] = {},
        ["METHODS"] = {}
    }
    
    for _, field in ipairs(ALL_FIELDS) do
        local group = field.namespace
        if field.name:find("Get") then group = "METHODS" end
        
        local menu_text = "üéØ " .. field.name
        if field.namespace == PROTEGE_NAMESPACE then
            menu_text = menu_text .. " (Protege)"
        end
        
        table.insert(namespace_groups[group], {
            text = menu_text,
            field = field
        })
    end
    
    -- Build menu options
    table.insert(menu_options, "üìÅ " .. MOB_NAMESPACE)
    for _, item in ipairs(namespace_groups[MOB_NAMESPACE]) do
        table.insert(menu_options, "   ‚Ä¢ " .. item.text)
        field_map[#menu_options] = item.field
    end
    
    table.insert(menu_options, "üìÅ " .. PROTEGE_NAMESPACE)
    for _, item in ipairs(namespace_groups[PROTEGE_NAMESPACE]) do
        table.insert(menu_options, "   ‚Ä¢ " .. item.text)
        field_map[#menu_options] = item.field
    end
    
    table.insert(menu_options, "üìÅ METHODS")
    for _, item in ipairs(namespace_groups["METHODS"]) do
        table.insert(menu_options, "   ‚Ä¢ " .. item.text)
        field_map[#menu_options] = item.field
    end
    
    table.insert(menu_options, "üîô Kembali")
    
    local choice = gg.choice(menu_options, nil, "üéÆ PILIH FIELD UNTUK MULTIPLIER\nNamespace-aware Selection")
    
    if choice == nil or choice == #menu_options then
        return nil
    end
    
    return field_map[choice]
end

-- Apply multiplier ke field tertentu
function apply_field_multiplier(field, multiplier)
    if not original_values[field.name] then
        gg.alert("‚ùå Field " .. field.name .. " belum di-backup!")
        return false
    end
    
    local original_value = original_values[field.name].value
    local new_value = original_value
    
    if field.type == gg.TYPE_FLOAT or field.type == gg.TYPE_DWORD then
        new_value = original_value * multiplier
    elseif field.type == gg.TYPE_BOOL then
        new_value = 1  -- Force true untuk boolean
    end
    
    gg.setValues({{
        address = original_values[field.name].address,
        value = new_value,
        flags = field.type
    }})
    
    gg.toast("‚úÖ " .. field.name .. " di-set ke: " .. new_value)
    return true
    end
-- Menu multiplier untuk field tertentu
function field_multiplier_menu(selected_field)
    while true do
        local menu_options = {
            "‚ö° Multiplier x2 - " .. selected_field.name,
            "‚ö° Multiplier x5 - " .. selected_field.name,
            "‚ö° Multiplier x10 - " .. selected_field.name,
            "üîß Custom Multiplier",
            "‚Ü©Ô∏è Kembali ke nilai original",
            "üîô Kembali ke menu utama"
        }
        
        local choice = gg.choice(menu_options, nil, "üéÆ MULTIPLIER UNTUK: " .. selected_field.name .. 
            "\nNamespace: " .. selected_field.namespace ..
            "\nDeskripsi: " .. selected_field.description)
        
        if choice == nil then break end
        
        if choice == 1 then
            apply_field_multiplier(selected_field, 2.0)
        elseif choice == 2 then
            apply_field_multiplier(selected_field, 5.0)
        elseif choice == 3 then
            apply_field_multiplier(selected_field, 10.0)
        elseif choice == 4 then
            local custom = gg.prompt("Masukkan custom multiplier:", {1.0}, {"number"})
            if custom and custom[1] then
                apply_field_multiplier(selected_field, custom[1])
            end
        elseif choice == 5 then
            gg.setValues({{
                address = original_values[selected_field.name].address,
                value = original_values[selected_field.name].value,
                flags = selected_field.type
            }})
            gg.toast("‚úÖ " .. selected_field.name .. " dikembalikan ke original")
        elseif choice == 6 then
            break
        end
        
        gg.sleep(500)
    end
end

-- Main menu dengan pilihan berdasarkan namespace
function namespace_based_menu()
    while true do
        local menu_options = {
            "üîπ Backup Semua Field (" .. #ALL_FIELDS .. " field)",
            "üéØ Pilih Field untuk Multiplier",
            "‚ö° Quick Multiplier - DisableDamageMotion",
            "‚ö° Quick Multiplier - DamageEffectColor", 
            "üìä Info Field yang Tersedia",
            "‚Ü©Ô∏è Revert Semua ke Original",
            "‚ùå Keluar"
        }
        
        local choice = gg.choice(menu_options, nil, "üéÆ NAMESPACE-BASED DAMAGE MULTIPLIER\n" ..
            "Mob Fields: " .. #MOB_FIELDS .. " | Protege Fields: " .. #PROTEGE_FIELDS)
        
        if choice == nil then break end
        
        if choice == 1 then
            backup_namespace_values()
        elseif choice == 2 then
            local selected_field = select_field_menu()
            if selected_field then
                field_multiplier_menu(selected_field)
            end
        elseif choice == 3 then
            -- Quick multiplier untuk DisableDamageMotion
            local field = MOB_FIELDS[1]  -- DisableDamageMotionAtSkillBreak
            if original_values[field.name] then
                apply_field_multiplier(field, 1)  -- Set ke true
                gg.alert("‚úÖ DisableDamageMotion diaktifkan!\nIni mungkin meningkatkan damage output")
            end
        elseif choice == 4 then
            -- Quick multiplier untuk DamageEffectColor
            local field = MOB_FIELDS[3]  -- DamageEffectColor_R
            if original_values[field.name] then
                apply_field_multiplier(field, 2.0)
                gg.toast("‚úÖ Damage effect color di-enhanced")
            end
        elseif choice == 5 then
            show_field_info()
        elseif choice == 6 then
            revert_all_fields()
        elseif choice == 7 then
            break
        end
    end
end

-- Tampilkan info field yang available
function show_field_info()
    local info_text = "üìä FIELD INFORMATION:\n\n"
    
    info_text = info_text .. "üìÅ " .. MOB_NAMESPACE .. ":\n"
    for _, field in ipairs(MOB_FIELDS) do
        info_text = info_text .. "‚Ä¢ " .. field.name .. " (" .. field.description .. ")\n"
    end
    
    info_text = info_text .. "\nüìÅ " .. PROTEGE_NAMESPACE .. ":\n"
    for _, field in ipairs(PROTEGE_FIELDS) do
        info_text = info_text .. "‚Ä¢ " .. field.name .. " (" .. field.description .. ")\n"
    end
    
    info_text = info_text .. "\n‚öôÔ∏è METHODS:\n"
    for _, method in ipairs(METHOD_OFFSETS) do
        info_text = info_text .. "‚Ä¢ " .. method.name .. " (" .. method.description .. ")\n"
    end
    
    gg.alert(info_text)
end

-- Revert semua field ke original
function revert_all_fields()
    for name, data in pairs(original_values) do
        gg.setValues({{
            address = data.address,
            value = data.value,
            flags = data.flags
        }})
    end
    gg.toast("‚úÖ Semua field dikembalikan ke nilai original")
end

-- Inisialisasi
gg.toast("üéÆ Namespace-Based Damage Multiplier Loaded")
gg.alert("‚ö†Ô∏è  PERHATIAN:\n" ..
    "Script ini mengacu pada struktur namespace yang benar:\n" ..
    "‚Ä¢ " .. MOB_NAMESPACE .. ": " .. #MOB_FIELDS .. " field\n" ..
    "‚Ä¢ " .. PROTEGE_NAMESPACE .. ": " .. #PROTEGE_FIELDS .. " field\n\n" ..
    "Selalu backup terlebih dahulu!")

-- Jalankan main menu
namespace_based_menu()

-- Auto-revert on exit
function onExit()
    revert_all_fields()
    gg.toast("üîÑ Semua perubahan direvert otomatis")
end

gg.registerExitHandler(onExit)    },
    {
        name = "DamageEffectColor_G",
        offset = 0xBC, 
        type = gg.TYPE_FLOAT,
        namespace = MOB_NAMESPACE,
        description = "Warna Green efek damage"
    },
    {
        name = "DamageEffectColor_B",
        offset = 0xC0,
        type = gg.TYPE_FLOAT,
        namespace = MOB_NAMESPACE,
        description = "Warna Blue efek damage"
    },
    {
        name = "DeadSinkSpeed",
        offset = 0xE0,
        type = gg.TYPE_FLOAT,
        namespace = MOB_NAMESPACE,
        description = "Kecepatan sink karakter mati"
    }
}

local PROTEGE_FIELDS = {
    {
        name = "DamageEffectSetColor",
        offset = 0x84,
        type = gg.TYPE_BOOL,
        namespace = PROTEGE_NAMESPACE,
        description = "Aktifkan warna custom efek damage (Protege)"
    },
    {
        name = "DamageEffectColor_R",
        offset = 0x88,
        type = gg.TYPE_FLOAT,
        namespace = PROTEGE_NAMESPACE,
        description = "Warna Red efek damage (Protege)"
    },
    {
        name = "DamageEffectColor_G",
        offset = 0x8C,
        type = gg.TYPE_FLOAT,
        namespace = PROTEGE_NAMESPACE,
        description = "Warna Green efek damage (Protege)"
    },
    {
        name = "DamageEffectColor_B",
        offset = 0x90,
        type = gg.TYPE_FLOAT,
        namespace = PROTEGE_NAMESPACE,
        description = "Warna Blue efek damage (Protege)"
    }
}

-- Method offsets untuk hooking
local METHOD_OFFSETS = {
    {
        name = "GetDisableDamageMotionAtSkillBreak",
        offset = 0x2F22A58,
        type = gg.TYPE_DWORD,
        namespace = MOB_NAMESPACE,
        description = "Method untuk disable damage motion"
    },
    {
        name = "GetDamageEffectPath", 
        offset = 0x2E2E354,
        type = gg.TYPE_DWORD,
        namespace = MOB_NAMESPACE,
        description = "Method untuk path efek damage"
    }
}

-- Gabungkan semua field
local ALL_FIELDS = {}
for _, field in ipairs(MOB_FIELDS) do table.insert(ALL_FIELDS, field) end
for _, field in ipairs(PROTEGE_FIELDS) do table.insert(ALL_FIELDS, field) end
for _, method in ipairs(METHOD_OFFSETS) do table.insert(ALL_FIELDS, method) end

-- Variabel global
local original_values = {}
local base_address = 0
local current_multiplier = 1.0
local is_active = false

-- Fungsi mendapatkan base address
function get_base_address()
    local ranges = gg.getRangesList(LIB_NAME)
    if #ranges == 0 then
        gg.alert("‚ùå " .. LIB_NAME .. " tidak ditemukan!")
        os.exit()
    end
    return ranges[1].start
end

-- Backup nilai original berdasarkan namespace
function backup_namespace_values()
    base_address = get_base_address()
    original_values = {}
    
    for _, field in ipairs(ALL_FIELDS) do
        local success, result = pcall(function()
            return gg.getValues({{address = base_address + field.offset, flags = field.type}})[1].value
        end)
        
        if success then
            original_values[field.name] = {
                address = base_address + field.offset,
                value = result,
                flags = field.type,
                namespace = field.namespace,
                description = field.description
            }
        end
    end
    
    gg.toast("‚úÖ Backup berhasil: " .. #ALL_FIELDS .. " field")
end

-- Menu untuk memilih field berdasarkan namespace
function select_field_menu()
    local menu_options = {}
    local field_map = {}
    
    -- Group oleh namespace
    local namespace_groups = {
        [MOB_NAMESPACE] = {},
        [PROTEGE_NAMESPACE] = {},
        ["METHODS"] = {}
    }
    
    for _, field in ipairs(ALL_FIELDS) do
        local group = field.namespace
        if field.name:find("Get") then group = "METHODS" end
        
        local menu_text = "üéØ " .. field.name
        if field.namespace == PROTEGE_NAMESPACE then
            menu_text = menu_text .. " (Protege)"
        end
        
        table.insert(namespace_groups[group], {
            text = menu_text,
            field = field
        })
    end
    
    -- Build menu options
    table.insert(menu_options, "üìÅ " .. MOB_NAMESPACE)
    for _, item in ipairs(namespace_groups[MOB_NAMESPACE]) do
        table.insert(menu_options, "   ‚Ä¢ " .. item.text)
        field_map[#menu_options] = item.field
    end
    
    table.insert(menu_options, "üìÅ " .. PROTEGE_NAMESPACE)
    for _, item in ipairs(namespace_groups[PROTEGE_NAMESPACE]) do
        table.insert(menu_options, "   ‚Ä¢ " .. item.text)
        field_map[#menu_options] = item.field
    end
    
    table.insert(menu_options, "üìÅ METHODS")
    for _, item in ipairs(namespace_groups["METHODS"]) do
        table.insert(menu_options, "   ‚Ä¢ " .. item.text)
        field_map[#menu_options] = item.field
    end
    
    table.insert(menu_options, "üîô Kembali")
    
    local choice = gg.choice(menu_options, nil, "üéÆ PILIH FIELD UNTUK MULTIPLIER\nNamespace-aware Selection")
    
    if choice == nil or choice == #menu_options then
        return nil
    end
    
    return field_map[choice]
end

-- Apply multiplier ke field tertentu
function apply_field_multiplier(field, multiplier)
    if not original_values[field.name] then
        gg.alert("‚ùå Field " .. field.name .. " belum di-backup!")
        return false
    end
    
    local original_value = original_values[field.name].value
    local new_value = original_value
    
    if field.type == gg.TYPE_FLOAT or field.type == gg.TYPE_DWORD then
        new_value = original_value * multiplier
    elseif field.type == gg.TYPE_BOOL then
        new_value = 1  -- Force true untuk boolean
    end
    
    gg.setValues({{
        address = original_values[field.name].address,
        value = new_value,
        flags = field.type
    }})
    
    gg.toast("‚úÖ " .. field.name .. " di-set ke: " .. new_value)
    return true
}

-- Menu multiplier untuk field tertentu
function field_multiplier_menu(selected_field)
    while true do
        local menu_options = {
            "‚ö° Multiplier x2 - " .. selected_field.name,
            "‚ö° Multiplier x5 - " .. selected_field.name,
            "‚ö° Multiplier x10 - " .. selected_field.name,
            "üîß Custom Multiplier",
            "‚Ü©Ô∏è Kembali ke nilai original",
            "üîô Kembali ke menu utama"
        }
        
        local choice = gg.choice(menu_options, nil, "üéÆ MULTIPLIER UNTUK: " .. selected_field.name .. 
            "\nNamespace: " .. selected_field.namespace ..
            "\nDeskripsi: " .. selected_field.description)
        
        if choice == nil then break end
        
        if choice == 1 then
            apply_field_multiplier(selected_field, 2.0)
        elseif choice == 2 then
            apply_field_multiplier(selected_field, 5.0)
        elseif choice == 3 then
            apply_field_multiplier(selected_field, 10.0)
        elseif choice == 4 then
            local custom = gg.prompt("Masukkan custom multiplier:", {1.0}, {"number"})
            if custom and custom[1] then
                apply_field_multiplier(selected_field, custom[1])
            end
        elseif choice == 5 then
            gg.setValues({{
                address = original_values[selected_field.name].address,
                value = original_values[selected_field.name].value,
                flags = selected_field.type
            }})
            gg.toast("‚úÖ " .. selected_field.name .. " dikembalikan ke original")
        elseif choice == 6 then
            break
        end
        
        gg.sleep(500)
    end
end

-- Main menu dengan pilihan berdasarkan namespace
function namespace_based_menu()
    while true do
        local menu_options = {
            "üîπ Backup Semua Field (" .. #ALL_FIELDS .. " field)",
            "üéØ Pilih Field untuk Multiplier",
            "‚ö° Quick Multiplier - DisableDamageMotion",
            "‚ö° Quick Multiplier - DamageEffectColor", 
            "üìä Info Field yang Tersedia",
            "‚Ü©Ô∏è Revert Semua ke Original",
            "‚ùå Keluar"
        }
        
        local choice = gg.choice(menu_options, nil, "üéÆ NAMESPACE-BASED DAMAGE MULTIPLIER\n" ..
            "Mob Fields: " .. #MOB_FIELDS .. " | Protege Fields: " .. #PROTEGE_FIELDS)
        
        if choice == nil then break end
        
        if choice == 1 then
            backup_namespace_values()
        elseif choice == 2 then
            local selected_field = select_field_menu()
            if selected_field then
                field_multiplier_menu(selected_field)
            end
        elseif choice == 3 then
            -- Quick multiplier untuk DisableDamageMotion
            local field = MOB_FIELDS[1]  -- DisableDamageMotionAtSkillBreak
            if original_values[field.name] then
                apply_field_multiplier(field, 1)  -- Set ke true
                gg.alert("‚úÖ DisableDamageMotion diaktifkan!\nIni mungkin meningkatkan damage output")
            end
        elseif choice == 4 then
            -- Quick multiplier untuk DamageEffectColor
            local field = MOB_FIELDS[3]  -- DamageEffectColor_R
            if original_values[field.name] then
                apply_field_multiplier(field, 2.0)
                gg.toast("‚úÖ Damage effect color di-enhanced")
            end
        elseif choice == 5 then
            show_field_info()
        elseif choice == 6 then
            revert_all_fields()
        elseif choice == 7 then
            break
        end
    end
end

-- Tampilkan info field yang available
function show_field_info()
    local info_text = "üìä FIELD INFORMATION:\n\n"
    
    info_text = info_text .. "üìÅ " .. MOB_NAMESPACE .. ":\n"
    for _, field in ipairs(MOB_FIELDS) do
        info_text = info_text .. "‚Ä¢ " .. field.name .. " (" .. field.description .. ")\n"
    end
    
    info_text = info_text .. "\nüìÅ " .. PROTEGE_NAMESPACE .. ":\n"
    for _, field in ipairs(PROTEGE_FIELDS) do
        info_text = info_text .. "‚Ä¢ " .. field.name .. " (" .. field.description .. ")\n"
    end
    
    info_text = info_text .. "\n‚öôÔ∏è METHODS:\n"
    for _, method in ipairs(METHOD_OFFSETS) do
        info_text = info_text .. "‚Ä¢ " .. method.name .. " (" .. method.description .. ")\n"
    end
    
    gg.alert(info_text)
end

-- Revert semua field ke original
function revert_all_fields()
    for name, data in pairs(original_values) do
        gg.setValues({{
            address = data.address,
            value = data.value,
            flags = data.flags
        }})
    end
    gg.toast("‚úÖ Semua field dikembalikan ke nilai original")
end

-- Inisialisasi
gg.toast("üéÆ Namespace-Based Damage Multiplier Loaded")
gg.alert("‚ö†Ô∏è  PERHATIAN:\n" ..
    "Script ini mengacu pada struktur namespace yang benar:\n" ..
    "‚Ä¢ " .. MOB_NAMESPACE .. ": " .. #MOB_FIELDS .. " field\n" ..
    "‚Ä¢ " .. PROTEGE_NAMESPACE .. ": " .. #PROTEGE_FIELDS .. " field\n\n" ..
    "Selalu backup terlebih dahulu!")

-- Jalankan main menu
namespace_based_menu()

-- Auto-revert on exit
function onExit()
    revert_all_fields()
    gg.toast("üîÑ Semua perubahan direvert otomatis")
end

gg.registerExitHandler(onExit)    if base_address == nil or base_address == 0 then
        gg.alert("‚ùå ERROR: Base address tidak valid!")
        os.exit()
    end
    
    return base_address
end

-- Fungsi backup nilai original dengan enhanced safety
function backup_original_values()
    local base = get_base_address()
    
    -- Backup semua nilai yang relevan
    original_values = {
        damage_motion = {
            address = base + TARGET_OFFSETS.DAMAGE_MULTIPLIER,
            original = gg.getValues({{address = base + TARGET_OFFSETS.DAMAGE_MULTIPLIER, flags = gg.TYPE_DWORD}})[1].value,
            flags = gg.TYPE_DWORD
        },
        damage_effect = {
            address = base + TARGET_OFFSETS.DAMAGE_EFFECT,
            original = gg.getValues({{address = base + TARGET_OFFSETS.DAMAGE_EFFECT, flags = gg.TYPE_DWORD}})[1].value,
            flags = gg.TYPE_DWORD
        },
        hp_setting = {
            address = base + TARGET_OFFSETS.HP_SETTING,
            original = gg.getValues({{address = base + TARGET_OFFSETS.HP_SETTING, flags = gg.TYPE_DWORD}})[1].value,
            flags = gg.TYPE_DWORD
        }
    }
    
    gg.toast("‚úÖ Backup nilai original berhasil")
    return true
end

-- Fungsi apply damage multiplier yang lebih aman
function apply_damage_multiplier(multiplier)
    if not safety_check() then
        gg.alert("‚ùå Gagal safety check! Tidak dapat menerapkan multiplier.")
        return false
    end
    
    local base = get_base_address()
    current_multiplier = multiplier
    
    -- Modifikasi bertahap dengan delay untuk hindari detection
    gg.sleep(100)
    
    -- 1. Modifikasi damage motion setting (nilai kecil dulu)
    gg.setValues({
        {
            address = original_values.damage_motion.address,
            value = 1,
            flags = gg.TYPE_DWORD
        }
    })
    
    gg.sleep(50)
    
    -- 2. Modifikasi damage effect
    gg.setValues({
        {
            address = original_values.damage_effect.address,
            value = 1,
            flags = gg.TYPE_DWORD
        }
    })
    
    gg.sleep(50)
    
    -- 3. Modifikasi HP setting (opsional)
    if not safe_mode then
        gg.setValues({
            {
                address = original_values.hp_setting.address,
                value = 9999,  -- Nilai HP tinggi
                flags = gg.TYPE_DWORD
            }
        })
    end
    
    is_active = true
    gg.toast("‚úÖ Damage Multiplier x" .. multiplier .. " diaktifkan")
    return true
end

-- Fungsi revert yang lebih comprehensive
function revert_to_original()
    if not original_values.damage_motion or not original_values.damage_effect then
        gg.alert("‚ùå Backup nilai tidak ditemukan!")
        return false
    end
    
    -- Revert semua nilai ke original
    gg.setValues({
        {
            address = original_values.damage_motion.address,
            value = original_values.damage_motion.original,
            flags = original_values.damage_motion.flags
        },
        {
            address = original_values.damage_effect.address,
            value = original_values.damage_effect.original,
            flags = original_values.damage_effect.flags
        }
    })
    
    if original_values.hp_setting then
        gg.setValues({
            {
                address = original_values.hp_setting.address,
                value = original_values.hp_setting.original,
                flags = original_values.hp_setting.flags
            }
        })
    end
    
    is_active = false
    current_multiplier = 1.0
    gg.toast("‚úÖ Revert ke nilai original berhasil")
    return true
end

-- Enhanced safety check
function safety_check()
    local base = get_base_address()
    
    -- Check jika base address valid
    if base == 0 or base == nil then
        return false
    end
    
    -- Check nilai-nilai critical
    local current_motion = gg.getValues({{address = base + TARGET_OFFSETS.DAMAGE_MULTIPLIER, flags = gg.TYPE_DWORD}})[1].value
    local current_effect = gg.getValues({{address = base + TARGET_OFFSETS.DAMAGE_EFFECT, flags = gg.TYPE_DWORD}})[1].value
    
    -- Validasi nilai tidak extreme
    if current_motion > 1000 or current_effect > 1000 then
        gg.alert("‚ö†Ô∏è  Nilai tidak normal terdeteksi!")
        return false
    end
    
    return true
end

-- Fungsi test stability
function test_stability()
    gg.toast("üîç Testing stability...")
    gg.sleep(1000)
    
    if safety_check() then
        gg.toast("‚úÖ Stability test passed")
        return true
    else
        gg.toast("‚ùå Stability test failed")
        return false
    end
end

-- Auto-repair function
function auto_repair()
    gg.alert("üõ†Ô∏è  Memulai auto-repair...")
    
    -- Coba revert dulu
    revert_to_original()
    gg.sleep(1000)
    
    -- Test stability
    if test_stability() then
        gg.alert("‚úÖ Auto-repair berhasil!")
        return true
    else
        gg.alert("‚ùå Auto-repair gagal! Coba restart game.")
        return false
    end
end

-- Main menu dengan lebih banyak opsi
function main_menu()
    while true do
        local menu_options = {
            "üîπ Backup Nilai Original",
            "‚ö° Damage Multiplier x2",
            "‚ö° Damage Multiplier x5", 
            "‚ö° Damage Multiplier x10",
            "üõ°Ô∏è  Safe Mode: " .. (safe_mode and "ON" or "OFF"),
            "üîß Auto-Repair",
            "üîç Status System",
            "‚Ü©Ô∏è  Revert ke Original",
            "‚ùå Keluar"
        }
        
        local choice = gg.choice(menu_options, nil, "üéÆ ADVANCED DAMAGE MENU\nCurrent: x" .. current_multiplier)
        
        if choice == nil then break end
        
        if choice == 1 then
            backup_original_values()
        elseif choice == 2 then
            apply_damage_multiplier(2.0)
        elseif choice == 3 then
            apply_damage_multiplier(5.0)
        elseif choice == 4 then
            apply_damage_multiplier(10.0)
        elseif choice == 5 then
            safe_mode = not safe_mode
            gg.toast("Safe Mode: " .. (safe_mode and "ON" or "OFF"))
        elseif choice == 6 then
            auto_repair()
        elseif choice == 7 then
            show_status()
        elseif choice == 8 then
            revert_to_original()
        elseif choice == 9 then
            break
        end
        
        gg.sleep(500)
    end
end

-- Fungsi show status yang lebih detail
function show_status()
    local base = get_base_address()
    local motion_val = gg.getValues({{address = base + TARGET_OFFSETS.DAMAGE_MULTIPLIER, flags = gg.TYPE_DWORD}})[1].value
    local effect_val = gg.getValues({{address = base + TARGET_OFFSETS.DAMAGE_EFFECT, flags = gg.TYPE_DWORD}})[1].value
    local hp_val = gg.getValues({{address = base + TARGET_OFFSETS.HP_SETTING, flags = gg.TYPE_DWORD}})[1].value
    
    local status_text = "üìä SYSTEM STATUS:\n"
    status_text = status_text .. "Multiplier Aktif: " .. tostring(is_active) .. "\n"
    status_text = status_text .. "Current Multiplier: x" .. current_multiplier .. "\n"
    status_text = status_text .. "Safe Mode: " .. (safe_mode and "ON" : "OFF") .. "\n"
    status_text = status_text .. "Damage Motion Value: " .. motion_val .. "\n"
    status_text = status_text .. "Damage Effect Value: " .. effect_val .. "\n"
    status_text = status_text .. "HP Setting Value: " .. hp_val .. "\n"
    status_text = status_text .. "Base Address: " .. string.format("%X", base)
    
    gg.alert(status_text)
end

-- Inisialisasi
gg.toast("üéÆ Advanced Damage Script Loaded")
gg.alert("‚ö†Ô∏è  PERINGATAN KEAMANAN:\n" ..
         "1. Gunakan di akun dummy/testing saja\n" ..
         "2. Script ini menggunakan teknik anti-detection\n" ..
         "3. Selalu backup nilai original terlebih dahulu!\n" ..
         "4. Safe Mode direkomendasikan untuk menghindari ban")

-- Jalankan stability test pertama
if test_stability() then
    gg.toast("‚úÖ System stabil, siap digunakan")
else
    gg.alert("‚ö†Ô∏è  System tidak stabil! Disarankan restart game.")
end

-- Jalankan main menu
main_menu()

-- Auto-revert saat script exit
function onExit()
    if is_active then
        gg.toast("üîÑ Revert otomatis...")
        revert_to_original()
    end
    gg.toast("Script dihentikan")
end

gg.registerExitHandler(onExit)            value = gg.getValues({{address = base + DAMAGE_MOTION_OFFSET, flags = gg.TYPE_DWORD}})[1].value,
            flags = gg.TYPE_DWORD
        },
        damage_effect = {
            address = base + DAMAGE_EFFECT_OFFSET,
            value = gg.getValues({{address = base + DAMAGE_EFFECT_OFFSET, flags = gg.TYPE_DWORD}})[1].value,
            flags = gg.TYPE_DWORD
        }
    }
    
    gg.toast("‚úÖ Backup nilai original berhasil")
end

-- Fungsi apply damage multiplier
function apply_damage_multiplier(multiplier)
    local base = get_base_address()
    current_multiplier = multiplier
    
    -- Modifikasi damage motion setting
    gg.setValues({
        {
            address = base + DAMAGE_MOTION_OFFSET,
            value = 1,  -- Force disable damage motion
            flags = gg.TYPE_DWORD
        }
    })
    
    -- Modifikasi damage effect (optional)
    gg.setValues({
        {
            address = base + DAMAGE_EFFECT_OFFSET,
            value = 1,  -- Enhance damage effect
            flags = gg.TYPE_DWORD
        }
    })
    
    is_active = true
    gg.toast("‚úÖ Damage Multiplier x" .. multiplier .. " diaktifkan")
end

-- Fungsi revert ke nilai original
function revert_to_original()
    if original_values.damage_motion then
        gg.setValues({
            {
                address = original_values.damage_motion.address,
                value = original_values.damage_motion.value,
                flags = original_values.damage_motion.flags
            }
        })
    end
    
    if original_values.damage_effect then
        gg.setValues({
            {
                address = original_values.damage_effect.address,
                value = original_values.damage_effect.value,
                flags = original_values.damage_effect.flags
            }
        })
    end
    
    is_active = false
    gg.toast("‚úÖ Revert ke nilai original berhasil")
end

-- Fungsi safety check
function safety_check()
    local base = get_base_address()
    local current_motion = gg.getValues({{address = base + DAMAGE_MOTION_OFFSET, flags = gg.TYPE_DWORD}})[1].value
    local current_effect = gg.getValues({{address = base + DAMAGE_EFFECT_OFFSET, flags = gg.TYPE_DWORD}})[1].value
    
    if not original_values.damage_motion then
        gg.alert("‚ùå ERROR: Backup belum dilakukan!")
        return false
    end
    
    -- Check jika nilai berubah secara tidak expected
    if current_motion ~= original_values.damage_motion.value and not is_active then
        gg.alert("‚ö†Ô∏è  WARNING: Nilai damage motion berubah tanpa sepengetahuan script!")
        return false
    end
    
    return true
end

-- Main menu
function main_menu()
    while true do
        local menu_options = {}
        
        if not is_active then
            menu_options = {
                "üîπ Backup Nilai Original",
                "‚ö° Damage Multiplier x2",
                "‚ö° Damage Multiplier x5", 
                "‚ö° Damage Multiplier x10",
                "üîç Status System",
                "‚ùå Keluar"
            }
        else
            menu_options = {
                "üîπ Backup Nilai Original",
                "‚ö° Damage Multiplier x2 (Aktif)",
                "‚ö° Damage Multiplier x5 (Aktif)",
                "‚ö° Damage Multiplier x10 (Aktif)",
                "‚Ü©Ô∏è  Revert ke Original",
                "üîç Status System",
                "‚ùå Keluar"
            }
        end
        
        local choice = gg.choice(menu_options, nil, "üéÆ MULTIPLE DAMAGE MENU\nCurrent: x" .. current_multiplier)
        
        if choice == nil then break end
        
        if choice == 1 then
            backup_original_values()
        elseif choice == 2 then
            if safety_check() then
                apply_damage_multiplier(2.0)
            end
        elseif choice == 3 then
            if safety_check() then
                apply_damage_multiplier(5.0)
            end
        elseif choice == 4 then
            if safety_check() then
                apply_damage_multiplier(10.0)
            end
        elseif choice == 5 then
            if is_active then
                revert_to_original()
            else
                show_status()
            end
        elseif choice == 6 then
            if is_active then
                show_status()
            else
                os.exit()
            end
        elseif choice == 7 then
            os.exit()
        end
        
        gg.sleep(500)
    end
end

-- Fungsi show status
function show_status()
    local base = get_base_address()
    local motion_val = gg.getValues({{address = base + DAMAGE_MOTION_OFFSET, flags = gg.TYPE_DWORD}})[1].value
    local effect_val = gg.getValues({{address = base + DAMAGE_EFFECT_OFFSET, flags = gg.TYPE_DWORD}})[1].value
    
    gg.alert("üìä SYSTEM STATUS:\n" ..
             "Multiplier Aktif: " .. tostring(is_active) .. "\n" ..
             "Current Multiplier: x" .. current_multiplier .. "\n" ..
             "Damage Motion Value: " .. motion_val .. "\n" ..
             "Damage Effect Value: " .. effect_val .. "\n" ..
             "Base Address: " .. string.format("%X", base))
end

-- Inisialisasi
gg.toast("üéÆ Multiple Damage Script Loaded")
gg.alert("‚ö†Ô∏è  PERINGATAN:\n" ..
         "1. Gunakan di akun dummy/testing saja\n" ..
         "2. Risiko ban/crash selalu ada\n" ..
         "3. Selalu backup nilai original terlebih dahulu!")

-- Jalankan main menu
main_menu()

-- Auto-revert saat script exit
function onExit()
    if is_active then
        revert_to_original()
    end
    gg.toast("Script dihentikan")
end

gg.registerExitHandler(onExit)
