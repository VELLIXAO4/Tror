-- ==========================================
-- Script Multiple Damage for Game Guardian
-- Berdasarkan analisis IL2CPP dump
-- Target: MobPrefabSetting & ProtegePrefabSetting
-- ==========================================

gg.setRanges(gg.REGION_C_ALLOC | gg.REGION_CODE_APP)
gg.clearResults()

-- Konfigurasi dasar
local LIB_NAME = "libil2cpp.so"
local DAMAGE_MOTION_OFFSET = 0x2E2E390  -- GetDisableDamageMotionAtSkillBreak()
local DAMAGE_EFFECT_OFFSET = 0x2E2E354  -- GetDamageEffectPath()

-- Variabel global untuk menyimpan state
local original_values = {}
local current_multiplier = 1.0
local is_active = false

-- Fungsi mendapatkan base address
function get_base_address()
    local ranges = gg.getRangesList(LIB_NAME)
    if #ranges == 0 then
        gg.alert("‚ùå ERROR: " .. LIB_NAME .. " tidak ditemukan!")
        os.exit()
    end
    return ranges[1].start
end

-- Fungsi backup nilai original
function backup_original_values()
    local base = get_base_address()
    
    original_values = {
        damage_motion = {
            address = base + DAMAGE_MOTION_OFFSET,
            value = gg.getValues({{address = base + DAMAGE_MOTION_OFFSET, flags = gg.TYPE_DWORD}})[1].value,
            flags = gg.TYPE_DWORD
        },
        damage_effect = {
            address = base + DAMAGE_EFFECT_OFFSET,
            value = gg.getValues({{address = base + DAMAGE_EFFECT_OFFSET, flags = gg.TYPE_DWORD}})[1].value,
            flags = gg.TYPE_DWORD
        }
    }
    
    gg.toast("‚úÖ Backup nilai original berhasil")
end

-- Fungsi apply damage multiplier
function apply_damage_multiplier(multiplier)
    local base = get_base_address()
    current_multiplier = multiplier
    
    -- Modifikasi damage motion setting
    gg.setValues({
        {
            address = base + DAMAGE_MOTION_OFFSET,
            value = 1,  -- Force disable damage motion
            flags = gg.TYPE_DWORD
        }
    })
    
    -- Modifikasi damage effect (optional)
    gg.setValues({
        {
            address = base + DAMAGE_EFFECT_OFFSET,
            value = 1,  -- Enhance damage effect
            flags = gg.TYPE_DWORD
        }
    })
    
    is_active = true
    gg.toast("‚úÖ Damage Multiplier x" .. multiplier .. " diaktifkan")
end

-- Fungsi revert ke nilai original
function revert_to_original()
    if original_values.damage_motion then
        gg.setValues({
            {
                address = original_values.damage_motion.address,
                value = original_values.damage_motion.value,
                flags = original_values.damage_motion.flags
            }
        })
    end
    
    if original_values.damage_effect then
        gg.setValues({
            {
                address = original_values.damage_effect.address,
                value = original_values.damage_effect.value,
                flags = original_values.damage_effect.flags
            }
        })
    end
    
    is_active = false
    gg.toast("‚úÖ Revert ke nilai original berhasil")
end

-- Fungsi safety check
function safety_check()
    local base = get_base_address()
    local current_motion = gg.getValues({{address = base + DAMAGE_MOTION_OFFSET, flags = gg.TYPE_DWORD}})[1].value
    local current_effect = gg.getValues({{address = base + DAMAGE_EFFECT_OFFSET, flags = gg.TYPE_DWORD}})[1].value
    
    if not original_values.damage_motion then
        gg.alert("‚ùå ERROR: Backup belum dilakukan!")
        return false
    end
    
    -- Check jika nilai berubah secara tidak expected
    if current_motion ~= original_values.damage_motion.value and not is_active then
        gg.alert("‚ö†Ô∏è  WARNING: Nilai damage motion berubah tanpa sepengetahuan script!")
        return false
    end
    
    return true
end

-- Main menu
function main_menu()
    while true do
        local menu_options = {}
        
        if not is_active then
            menu_options = {
                "üîπ Backup Nilai Original",
                "‚ö° Damage Multiplier x2",
                "‚ö° Damage Multiplier x5", 
                "‚ö° Damage Multiplier x10",
                "üîç Status System",
                "‚ùå Keluar"
            }
        else
            menu_options = {
                "üîπ Backup Nilai Original",
                "‚ö° Damage Multiplier x2 (Aktif)",
                "‚ö° Damage Multiplier x5 (Aktif)",
                "‚ö° Damage Multiplier x10 (Aktif)",
                "‚Ü©Ô∏è  Revert ke Original",
                "üîç Status System",
                "‚ùå Keluar"
            }
        end
        
        local choice = gg.choice(menu_options, nil, "üéÆ MULTIPLE DAMAGE MENU\nCurrent: x" .. current_multiplier)
        
        if choice == nil then break end
        
        if choice == 1 then
            backup_original_values()
        elseif choice == 2 then
            if safety_check() then
                apply_damage_multiplier(2.0)
            end
        elseif choice == 3 then
            if safety_check() then
                apply_damage_multiplier(5.0)
            end
        elseif choice == 4 then
            if safety_check() then
                apply_damage_multiplier(10.0)
            end
        elseif choice == 5 then
            if is_active then
                revert_to_original()
            else
                show_status()
            end
        elseif choice == 6 then
            if is_active then
                show_status()
            else
                os.exit()
            end
        elseif choice == 7 then
            os.exit()
        end
        
        gg.sleep(500)
    end
end

-- Fungsi show status
function show_status()
    local base = get_base_address()
    local motion_val = gg.getValues({{address = base + DAMAGE_MOTION_OFFSET, flags = gg.TYPE_DWORD}})[1].value
    local effect_val = gg.getValues({{address = base + DAMAGE_EFFECT_OFFSET, flags = gg.TYPE_DWORD}})[1].value
    
    gg.alert("üìä SYSTEM STATUS:\n" ..
             "Multiplier Aktif: " .. tostring(is_active) .. "\n" ..
             "Current Multiplier: x" .. current_multiplier .. "\n" ..
             "Damage Motion Value: " .. motion_val .. "\n" ..
             "Damage Effect Value: " .. effect_val .. "\n" ..
             "Base Address: " .. string.format("%X", base))
end

-- Inisialisasi
gg.toast("üéÆ Multiple Damage Script Loaded")
gg.alert("‚ö†Ô∏è  PERINGATAN:\n" ..
         "1. Gunakan di akun dummy/testing saja\n" ..
         "2. Risiko ban/crash selalu ada\n" ..
         "3. Selalu backup nilai original terlebih dahulu!")

-- Jalankan main menu
main_menu()

-- Auto-revert saat script exit
function onExit()
    if is_active then
        revert_to_original()
    end
    gg.toast("Script dihentikan")
end

gg.registerExitHandler(onExit)
